{% extends 'mediacenter/base.html' %}

{% block title %}ArcadeArtBox - Player{% endblock %}

{% block content %}
    <body style="text-align:center;background:black;">
        <div id="media-container" height="100%"></div>
        <script>
            var increment = .1;
            var time_increment = 10;
            var set_volume = .5;
            var player_muted = false;

            var player = new WebSocket(
                'ws://' + window.location.host +
                '/ws/player/');

            player.onmessage = function(e) {
                var data = JSON.parse(e.data);
                var message = data['message'];
                var messageType = message['type'];
                
                if(messageType === 'action') {
                    var action = message['action'];
                    var vid = document.getElementById('video');
                    try {
                        switch(action) {
                            case 'play':
                                play = vid.play;
                                play.call(vid);
                                break;
                            case 'pause':
                                pause = vid.pause;
                                pause.call(vid);
                                break;
                            case 'mute':
                                player_muted = !player_muted
                                vid.muted = player_muted
                                break;
                            case 'vol_up':
                                vol_up(vid);
                                break;
                            case 'vol_down':
                                vol_down(vid);
                                break;
                            case 'skip_forward':
                                skip_forward(vid);
                                break;
                            case 'skip_backward':
                                skip_backward(vid);
                                break;
                            default:
                                break;
                        }
                    } catch {
                        location.reload()
                    }
                } else if (messageType==='source') {
                    var source = message['source']
                    var type = message['player_type']

                    switch(type) {
                        case 'video':
                            create_video_elm(source);
                            break;
                        case 'photo':
                            create_photo_elm(source);
                            break;
                        default:
                            break;
                    }
                    
                }
            };

            player.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            var create_video_elm = function(source) {
                var container = document.getElementById('media-container')
                var template = "<video id=\"video\" controls height=\"100%\"><source src=\"" + source + "\" 'video/mp4; codecs=\"avc1.4D401E, mp4a.40.2\"'/></video>"
                container.innerHTML = template;

                var vid = document.getElementById('video');

                vid.volume = set_volume;
                vid.muted = player_muted;
        
                vid.onended = function() {
                    player.send(JSON.stringify({
                        'action': 'refresh'
                    }))
                };
                vid.play();
            }

            var create_photo_elm = function(source) {
                var container = document.getElementById('media-container')
                var template = "<img id=\"image\" src=\"" + source + "\" height=\"100%\"></img>" 
                container.innerHTML = template;
            }

            var vol_up = function (vid) {
                new_volume = set_volume + increment

                if (new_volume > 1) {
                    set_volume = 1
                } else {
                    set_volume = new_volume
                }

                vid.volume = set_volume
            }
            
            var vol_down = function (vid) {
                new_volume = set_volume - increment

                if (new_volume < 0) {
                    set_volume = 0
                } else {
                    set_volume = new_volume
                }

                vid.volume = set_volume
            }

            var skip_forward = function (vid) {
                new_time = vid.currentTime + time_increment;

                if (new_time > vid.duration) {
                    player.send(JSON.stringify({
                        'action': 'refresh'
                    }))
                } else {
                    vid.currentTime += new_time
                }
            }
            
            var skip_backward = function (vid) {
                new_time = vid.currentTime - time_increment;

                if (new_time < 0) {
                    vid.currentTime = 0
                } else {
                    vid.currentTime = new_time
                }
            }

        </script>
    </body>
{% endblock %}