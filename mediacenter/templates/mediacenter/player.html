{% load bootstrap4 %}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% load static %}

<!DOCTYPE html>
<html class=''>
    <head>
        <meta charset="utf-8">
        <title>ArcadeArtBox - Player</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="{% static 'tv-icon192.png' %}">
        <link rel="apple-touch-icon" sizes="57x57" href="{% static 'tv-icon57.png' %}">
        <link rel="apple-touch-icon" sizes="72x72" href="{% static 'tv-icon72.png' %}">
        <link rel="apple-touch-icon" sizes="114x114" href="{% static 'tv-icon114.png' %}">
        <link rel="apple-touch-icon" sizes="144x144" href="{% static 'tv-icon144.png' %}">
        <link rel="apple-touch-icon" sizes="60×60" href="{% static 'tv-icon60.png' %}">
        <link rel="apple-touch-icon" sizes="76×76" href="{% static 'tv-icon76.png' %}">
        <link rel="apple-touch-icon" sizes="120×120" href="{% static 'tv-icon120.png' %}">
        <link rel="apple-touch-icon" sizes="152×152" href="{% static 'tv-icon152.png' %}">
        <link rel="apple-touch-icon" sizes="180×180" href="{% static 'tv-icon180.png' %}">
        <link rel="icon" sizes="192×192" href="{% static 'tv-icon192.png' %}">
        <link rel="icon" sizes="128×128" href="{% static 'tv-icon128.png' %}">
    </head>
    <body style="text-align:center;background:black;">
        <div id="media-container" height="100%"></div>
        <script>
            var increment = .1;
            var set_volume = .5;
            var player_muted = false;

            var player = new WebSocket(
                'ws://' + window.location.host +
                '/ws/player/');

            player.onmessage = function(e) {
                var data = JSON.parse(e.data);
                var message = data['message'];
                var messageType = message['type'];
                
                if(messageType === 'action') {
                    var action = message['action'];
                    var vid = document.getElementById('video');
                    switch(action) {
                        case 'play':
                            play = vid.play;
                            play.call(vid);
                            break;
                        case 'pause':
                            pause = vid.pause;
                            pause.call(vid);
                            break;
                        case 'mute':
                            player_muted = !player_muted
                            vid.muted = player_muted
                            break;
                        case 'vol_up':
                            vol_up(vid);
                            break;
                        case 'vol_down':
                            vol_down(vid);
                            break;
                        default:
                            break;
                    }
                } else if (messageType==='source') {
                    var source = message['source']
                    var type = message['player_type']

                    switch(type) {
                        case 'video':
                            create_video_elm(source);
                            break;
                        case 'photo':
                            create_photo_elm(source);
                            break;
                        default:
                            break;
                    }
                    
                }
            };

            player.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            var create_video_elm = function(source) {
                var container = document.getElementById('media-container')
                var template = "<video id=\"video\" src=\"" + source + "\" height=\"100%\"></video>"
                container.innerHTML = template;

                var vid = document.getElementById('video');

                vid.volume = set_volume;
                vid.muted = player_muted;
        
                vid.onended = function() {
                    player.send(JSON.stringify({
                        'action': 'refresh'
                    }))
                };
                vid.play();
            }

            var create_photo_elm = function(source) {
                var container = document.getElementById('media-container')
                var template = "<img id=\"image\" src=\"" + source + "\" height=\"100%\"></img>" 
                container.innerHTML = template;
            }

            var vol_up = function (vid) {
                new_volume = set_volume + increment

                if (new_volume > 1) {
                    set_volume = 1
                } else {
                    set_volume = new_volume
                }

                vid.volume = set_volume
            }
            
            var vol_down = function (vid) {
                new_volume = set_volume - increment

                if (new_volume < 0) {
                    set_volume = 0
                } else {
                    set_volume = new_volume
                }

                vid.volume = set_volume
            }

        </script>
    </body>
</html>